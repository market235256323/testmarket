# ტაიმერის მუშაობის პრინციპი

## ცვლილებების მიმოხილვა

ტაიმერის ლოგიკა შეიცვალა, რომ ტაიმერი მხოლოდ კონკრეტულ ჩატში ჩანდეს. წინანდელი ვერსიაში ტაიმერი გლობალურად იყო მართული და როგორც სისტემური შეტყობინება, ასე გამოსახული. ახალ ვერსიაში:

1. **თითოეულ ჩატს აქვს საკუთარი ტაიმერი** - ყველა ტაიმერი შენახულია Firestore-ის ჩატის დოკუმენტში
2. **კონკრეტული ჩატის ტაიმერი** - ტაიმერი მხოლოდ იმ ჩატში ჩანს, რომელშიც ის დაიწყო
3. **სხვადასხვა ტრანზაქციები** - თუ სხვადასხვა ჩატებში მოხდება გადახდა, ყველა მათგანს ექნება საკუთარი, დამოუკიდებელი ტაიმერი
4. **ტაიმერის პოზიცია** - ტაიმერი ჩატის ზედა ნაწილში ჩანს როგორც UI კომპონენტი, და არა როგორც სისტემური შეტყობინება

## განახლება: ტაიმერის გამოსახვა მესიჯის ფორმატით

ბოლო განახლებაში შეიცვალა ტაიმერის ვიზუალური გამოსახვა:

1. **მესიჯის ფორმატი** - ტაიმერი ახლა გამოსახულია როგორც სისტემური შეტყობინება მესიჯის ფორმატით, ნაცვლად ზედა დივისა
2. **სისტემური შეტყობინების სტილი** - ტაიმერს აქვს სისტემური შეტყობინების გარეგნობა, ყვითელი ფერის ველით და "S" ასოთი ავატარში
3. **დროის მარკერი** - ყველა ტაიმერს აქვს დროის მარკერი, როდის გამოჩნდა შეტყობინება
4. **მომხმარებლის გამოცდილება** - ტაიმერი ახლა ჩანს როგორც ჩატის ნაწილი და არა როგორც განცალკევებული UI ელემენტი

## განახლება: გადახდის შემდეგ ტაიმერის ავტომატური გამოჩენა

ახალ ცვლილებებში, ტაიმერი ავტომატურად გამოჩნდება გადახდის დასრულების შემდეგ:

1. **ავტომატური დაწყება** - როდესაც გადახდა დასტურდება, სისტემა ავტომატურად იწყებს 7-დღიან ტაიმერს
2. **გარდამავალი მდგომარეობა** - თუ გადახდა დასრულებულია, მაგრამ ტაიმერი ჯერ არ არის გააქტიურებული, ნაჩვენებია გარდამავალი შეტყობინება
3. **მგომარეობის ცვლილება** - ტაიმერი ჩნდება გადახდის დასრულებისთანავე, მიუხედავად იმისა, სისტემური შეტყობინება აპდეიტდება თუ არა

### მაგალითი: გადახდის პროცესი და ტაიმერის ჩვენება

1. **გადახდამდე** - ტაიმერი არ ჩანს
2. **გადახდის პროცესში** - გამოჩნდება გადახდის სტატუსი და დამუშავების ინდიკატორი
3. **გადახდის დასრულებისთანავე**:
   - ჯერ გამოჩნდება შეტყობინება "გადახდა დასრულებულია, ტაიმერი ჩნდება"
   - შემდეგ ავტომატურად გამოჩნდება 7-დღიანი ტაიმერი
   - ტაიმერი შენახულია Firestore-ში და ასოცირებულია ამ კონკრეტულ ჩატთან
4. **სხვა ჩატში გადასვლისას** - ტაიმერი აღარ გამოჩნდება, რადგან ის მხოლოდ კონკრეტულ ჩატშია შენახული
5. **თავდაპირველ ჩატში დაბრუნებისას** - ტაიმერი ისევ გამოჩნდება იმავე განახლებული დროით

## ტექნიკური დეტალები

### მონაცემების სტრუქტურა

ჩატის დოკუმენტში შენახულია შემდეგი ველები ტაიმერის შესახებ:

```typescript
{
  timerActive?: boolean;         // არის თუ არა ტაიმერი აქტიური
  timerStartDate?: number;       // როდის დაიწყო ტაიმერი (Unix ტაიმსტემპი)
  timerEndDate?: number;         // როდის სრულდება ტაიმერი (Unix ტაიმსტემპი)
  transferTimerStarted?: boolean; // არის თუ არა ტრანსფერი ტაიმერი გაშვებული
  transferTimerStartedAt?: number; // როდის დაიწყო ტრანსფერის ტაიმერი
  transferReadyTime?: number;     // როდის იქნება ტრანსფერი მზად
}
```

### მუშაობის პრინციპი

1. **ჩატში შესვლისას**:
   - სისტემა კითხულობს ჩატის დოკუმენტს და ამოწმებს ტაიმერის მდგომარეობას
   - თუ ტაიმერი აქტიურია, კომპონენტი იწყებს ტაიმერის განახლებას ყოველ წამში
   
2. **ჩატების ცვლილებისას**:
   - წინა ჩატის ტაიმერები იწმინდება
   - ახალი ჩატის ტაიმერების მდგომარეობა იტვირთება
   
3. **ტაიმერის დაწყება**:
   - ახალი ტაიმერის დაწყება შესაძლებელია მხოლოდ სერვერის მეშვეობით
   - სერვერი განაახლებს ჩატის დოკუმენტს
   - კლიენტი მიიღებს ცვლილებებს ონსნაპშოტით
   - გადახდის შემდეგ ტაიმერი ასევე ავტომატურად იწყება კლიენტის მხარეს

## ცვლილების მიზანი

ეს ცვლილება უზრუნველყოფს, რომ:

1. თითოეული ჩატის ტაიმერი იყოს იზოლირებული და დამოუკიდებელი
2. გადახდის ტაიმერები მხოლოდ იმ ჩატში ჩანდეს, სადაც გადახდა მოხდა
3. მომხმარებელს შეეძლოს ნათლად დაინახოს, რომელი ტრანზაქციის ტაიმერს უყურებს
4. გადახდის დასრულებისთანავე ტაიმერი ავტომატურად ჩაირთოს და გამოჩნდეს
5. ტაიმერი გამოჩნდეს ჩატის ნაკადის ნაწილად, როგორც სისტემური შეტყობინება

## მომავალი გაუმჯობესება

შესაძლო გაუმჯობესებები მომავალში:

1. ტაიმერის დასრულების შემდეგ ავტომატური ქმედებების დამატება
2. ტაიმერის ვიზუალის გაუმჯობესება
3. ტაიმერის ისტორიის შენახვა და ჩვენება 